<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Christmas Gifts & Lights</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #000000;
        font-family: "Segoe UI", sans-serif;
      }
      #canvas-container {
        width: 100%;
        height: 100vh;
        display: block;
      }

      #ui-layer {
        position: absolute;
        bottom: 30px;
        width: 100%;
        text-align: center;
        pointer-events: none;
        z-index: 100;
      }

      .badge {
        display: inline-block;
        background: rgba(0, 0, 0, 0.7);
        border: 2px solid #ffd700;
        color: #ffd700;
        padding: 10px 25px;
        border-radius: 50px;
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        text-shadow: 0 0 10px #ffd700;
      }

      .guide {
        color: #ccc;
        font-size: 13px;
        margin-bottom: 20px;
        text-shadow: 0 2px 4px black;
      }

      button {
        pointer-events: auto;
        cursor: pointer;
        background: linear-gradient(to bottom, #d32f2f, #8b0000);
        color: #fff;
        border: 2px solid #ffd700;
        padding: 15px 50px;
        border-radius: 30px;
        font-weight: 800;
        font-size: 16px;
        box-shadow: 0 0 30px rgba(255, 0, 0, 0.6);
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }

      #error-log {
        display: none;
        position: absolute;
        top: 0;
        left: 0;
        color: red;
        background: rgba(0, 0, 0, 0.8);
        z-index: 999;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div id="error-log"></div>
    <div id="ui-layer">
      <div id="status" class="badge">ðŸŽ„ GiÃ¡ng Sinh An LÃ nh ðŸŽ„</div>
      <div class="guide"></div>
    </div>

    <div id="canvas-container"></div>

    <script>
      // Nháº¡c ná»n
      const MUSIC_URL = "./audio.mp3";
      let bgMusic = new Audio(MUSIC_URL);
      bgMusic.loop = true;
      bgMusic.volume = 1.0;

      // áº¢nh
      const loader = new THREE.TextureLoader();
      const photoFiles = [
        "./dai1.jpg",
        "./dai2.jpg",
        "./dai3.jpg",
        "./dai4.jpg",
        "./dai5.jpg",
      ];
      const photoTextures = [];
      photoFiles.forEach((f, i) => (photoTextures[i] = loader.load(f)));

      // Texture tÃ¹y chá»‰nh
      function createCustomTexture(type) {
        const canvas = document.createElement("canvas");
        canvas.width = 128;
        canvas.height = 128;
        const ctx = canvas.getContext("2d");
        const cx = 64,
          cy = 64;

        if (type === "gold_glow") {
          const grd = ctx.createRadialGradient(cx, cy, 0, cx, cy, 40);
          grd.addColorStop(0, "#FFFFFF");
          grd.addColorStop(0.2, "#FFFFE0");
          grd.addColorStop(0.5, "#FFD700");
          grd.addColorStop(1, "rgba(0,0,0,0)");
          ctx.fillStyle = grd;
          ctx.fillRect(0, 0, 128, 128);
        } else if (type === "red_light") {
          const grd = ctx.createRadialGradient(cx, cy, 0, cx, cy, 50);
          grd.addColorStop(0, "#FFAAAA");
          grd.addColorStop(0.3, "#FF0000");
          grd.addColorStop(1, "rgba(0,0,0,0)");
          ctx.fillStyle = grd;
          ctx.fillRect(0, 0, 128, 128);
        } else if (type === "gift_red") {
          ctx.fillStyle = "#D32F2F";
          ctx.fillRect(20, 20, 88, 88);
          ctx.fillStyle = "#FFD700";
          ctx.fillRect(54, 20, 20, 88);
          ctx.fillRect(20, 54, 88, 20);
          ctx.strokeStyle = "rgba(0,0,0,0.3)";
          ctx.lineWidth = 2;
          ctx.strokeRect(20, 20, 88, 88);
        }
        return new THREE.CanvasTexture(canvas);
      }

      const textures = {
        gold: createCustomTexture("gold_glow"),
        red: createCustomTexture("red_light"),
        gift: createCustomTexture("gift_red"),
      };

      // Cáº¥u hÃ¬nh
      const CONFIG = {
        goldCount: 2000,
        redCount: 300,
        giftCount: 150,
        explodeRadius: 65,
        photoOrbitRadius: 25,
        treeHeight: 70,
        treeBaseRadius: 35,
      };

      // Biáº¿n toÃ n cá»¥c
      let scene, camera, renderer;
      let groupGold, groupRed, groupGift;
      let photoMeshes = [];
      let titleMesh, starMesh;

      let state = "TREE"; // Tráº¡ng thÃ¡i ban Ä‘áº§u: TREE
      let selectedIndex = 0;
      let handX = 0.5; // Giá»¯ Ä‘á»ƒ animate khÃ´ng lá»—i (dÃ¹ng xoay)

      // Khá»Ÿi táº¡o 3D
      function init3D() {
        const container = document.getElementById("canvas-container");
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.002);

        camera = new THREE.PerspectiveCamera(
          60,
          window.innerWidth / window.innerHeight,
          0.1,
          1000
        );
        camera.position.z = 100;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        groupGold = createParticleSystem("gold", CONFIG.goldCount, 2.0);
        groupRed = createParticleSystem("red", CONFIG.redCount, 3.5);
        groupGift = createParticleSystem("gift", CONFIG.giftCount, 3.0);

        createPhotos();
        createDecorations();
        animate();
      }

      // Há»‡ háº¡t
      function createParticleSystem(type, count, size) {
        const pPositions = [],
          pExplodeTargets = [],
          pTreeTargets = [];
        for (let i = 0; i < count; i++) {
          const h = Math.random() * CONFIG.treeHeight;
          const y = h - CONFIG.treeHeight / 2;
          let radiusRatio =
            type === "gold"
              ? Math.sqrt(Math.random())
              : 0.9 + Math.random() * 0.1;
          const maxR = (1 - h / CONFIG.treeHeight) * CONFIG.treeBaseRadius;
          const r = maxR * radiusRatio;
          const theta = Math.random() * Math.PI * 2;
          const tx = r * Math.cos(theta),
            tz = r * Math.sin(theta);
          pTreeTargets.push(tx, y, tz);

          const u = Math.random(),
            v = Math.random();
          const phi = Math.acos(2 * v - 1),
            lam = 2 * Math.PI * u;
          let radMult = type === "gift" ? 1.2 : 1.0;
          const rad = CONFIG.explodeRadius * Math.cbrt(Math.random()) * radMult;
          const ex = rad * Math.sin(phi) * Math.cos(lam);
          const ey = rad * Math.sin(phi) * Math.sin(lam);
          const ez = rad * Math.cos(phi);
          pExplodeTargets.push(ex, ey, ez);

          pPositions.push(tx, y, tz);
        }
        const geo = new THREE.BufferGeometry();
        geo.setAttribute(
          "position",
          new THREE.Float32BufferAttribute(pPositions, 3)
        );
        geo.userData = { tree: pTreeTargets, explode: pExplodeTargets };
        const mat = new THREE.PointsMaterial({
          size: size,
          map: textures[type],
          transparent: true,
          opacity: 1.0,
          blending:
            type === "gift" ? THREE.NormalBlending : THREE.AdditiveBlending,
          depthWrite: false,
          sizeAttenuation: true,
        });
        const points = new THREE.Points(geo, mat);
        scene.add(points);
        return points;
      }

      // áº¢nh
      function createPhotos() {
        const geo = new THREE.PlaneGeometry(8, 8);
        const borderGeo = new THREE.PlaneGeometry(9, 9);
        const borderMat = new THREE.MeshBasicMaterial({ color: 0xffd700 });

        for (let i = 0; i < 5; i++) {
          const mat = new THREE.MeshBasicMaterial({
            map: photoTextures[i],
            side: THREE.DoubleSide,
          });
          const mesh = new THREE.Mesh(geo, mat);
          const border = new THREE.Mesh(borderGeo, borderMat);
          border.position.z = -0.1;
          mesh.add(border);

          mesh.visible = false;
          mesh.scale.set(0, 0, 0);
          scene.add(mesh);
          photoMeshes.push(mesh);
        }
      }

      // Trang trÃ­
      function createDecorations() {
        const canvas = document.createElement("canvas");
        canvas.width = 1024;
        canvas.height = 256;
        const ctx = canvas.getContext("2d");
        ctx.font = 'bold italic 90px "Times New Roman"';
        ctx.fillStyle = "#FFD700";
        ctx.textAlign = "center";
        ctx.shadowColor = "#FF0000";
        ctx.shadowBlur = 40;
        ctx.fillText("MERRY CHRISTMAS", 512, 130);

        const tex = new THREE.CanvasTexture(canvas);
        const mat = new THREE.MeshBasicMaterial({
          map: tex,
          transparent: true,
          blending: THREE.AdditiveBlending,
        });
        titleMesh = new THREE.Mesh(new THREE.PlaneGeometry(60, 15), mat);
        titleMesh.position.set(0, 50, 0);
        scene.add(titleMesh);

        const starCanvas = document.createElement("canvas");
        starCanvas.width = 128;
        starCanvas.height = 128;
        const sCtx = starCanvas.getContext("2d");
        sCtx.fillStyle = "#FFFF00";
        sCtx.shadowColor = "#FFF";
        sCtx.shadowBlur = 20;
        sCtx.beginPath();
        const cx = 64,
          cy = 64,
          outer = 50,
          inner = 20;
        for (let i = 0; i < 5; i++) {
          sCtx.lineTo(
            cx + Math.cos(((18 + i * 72) / 180) * Math.PI) * outer,
            cy - Math.sin(((18 + i * 72) / 180) * Math.PI) * outer
          );
          sCtx.lineTo(
            cx + Math.cos(((54 + i * 72) / 180) * Math.PI) * inner,
            cy - Math.sin(((54 + i * 72) / 180) * Math.PI) * inner
          );
        }
        sCtx.closePath();
        sCtx.fill();
        const starTex = new THREE.CanvasTexture(starCanvas);
        const starMat = new THREE.MeshBasicMaterial({
          map: starTex,
          transparent: true,
          blending: THREE.AdditiveBlending,
        });
        starMesh = new THREE.Mesh(new THREE.PlaneGeometry(12, 12), starMat);
        starMesh.position.set(0, CONFIG.treeHeight / 2 + 2, 0);
        scene.add(starMesh);
      }

      // Cáº­p nháº­t nhÃ³m háº¡t
      function updateParticleGroup(
        group,
        targetState,
        speed,
        handRotY,
        time,
        isBlinking
      ) {
        const positions = group.geometry.attributes.position.array;
        const targetKey = targetState === "TREE" ? "tree" : "explode";
        const targets =
          group.geometry.userData[
            targetState === "PHOTO" ? "explode" : targetKey
          ];

        for (let i = 0; i < positions.length; i++) {
          positions[i] += (targets[i] - positions[i]) * speed;
        }
        group.geometry.attributes.position.needsUpdate = true;

        if (targetState === "TREE") {
          group.rotation.y += 0.003;
          if (isBlinking) {
            const scale = 1 + Math.sin(time * 5) * 0.2;
            group.scale.set(scale, scale, scale);
          } else {
            group.scale.set(1, 1, 1);
          }
        } else {
          group.scale.set(1, 1, 1);
          group.rotation.y += (handRotY - group.rotation.y) * 0.05;
        }
      }
 const isMobile = window.innerWidth < 768;
          const photoScale = isMobile ? 6 : 5;
      // VÃ²ng láº·p váº½
      function animate() {
        requestAnimationFrame(animate);
        const time = Date.now() * 0.001;
        const speed = 0.06;
        const handRotY = (handX - 0.5) * 2.5;

        updateParticleGroup(groupGold, state, speed, handRotY, time, false);
        updateParticleGroup(groupRed, state, speed, handRotY, time, true);
        updateParticleGroup(groupGift, state, speed, handRotY, time, false);

        photoMeshes.forEach((mesh, i) => {
          if (!mesh.material.map && photoTextures[i]) {
            mesh.material.map = photoTextures[i];
            mesh.material.needsUpdate = true;
          }
        });

        if (state === "TREE") {
          titleMesh.visible = true;
          starMesh.visible = true;
          titleMesh.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
          starMesh.rotation.z -= 0.02;
          photoMeshes.forEach((m) => {
            m.scale.lerp(new THREE.Vector3(0, 0, 0), 0.1);
            m.visible = false;
          });
        } else if (state === "EXPLODE") {
          titleMesh.visible = false;
          starMesh.visible = false;

          const baseAngle = groupGold.rotation.y;
          const angleStep = (Math.PI * 2) / 5;
          let bestIdx = 0,
            maxZ = -999;

          photoMeshes.forEach((mesh, i) => {
            mesh.visible = true;
            const angle = baseAngle + i * angleStep;
            const x = Math.sin(angle) * CONFIG.photoOrbitRadius;
            const z = Math.cos(angle) * CONFIG.photoOrbitRadius;
            const y = Math.sin(time + i) * 3;

            mesh.position.lerp(new THREE.Vector3(x, y, z), 0.1);
            mesh.lookAt(camera.position);

            if (z > maxZ) {
              maxZ = z;
              bestIdx = i;
            }

            if (z > 5) {
              const distScale = 1.0 + (z / CONFIG.photoOrbitRadius) * 0.8;
              mesh.scale.lerp(
                new THREE.Vector3(distScale, distScale, distScale),
                0.1
              );
            } else {
              mesh.scale.lerp(new THREE.Vector3(0.6, 0.6, 0.6), 0.1);
            }
          });
          selectedIndex = bestIdx;
        } else if (state === "PHOTO") {
          photoMeshes.forEach((mesh, i) => {
            if (i === selectedIndex) {
            mesh.position.lerp(new THREE.Vector3(0, 0, 40), 0.1);
mesh.scale.lerp(new THREE.Vector3(photoScale, photoScale, photoScale), 0.1);
  mesh.lookAt(camera.position);
  mesh.rotation.y += (handRotY - mesh.rotation.y) * 0.1;

            } else {
              mesh.scale.lerp(new THREE.Vector3(0, 0, 0), 0.1);
            }
          });
        }

        renderer.render(scene, camera);
      }

      // Báº¯t Ä‘áº§u há»‡ thá»‘ng
      function startSystem() {
        bgMusic.play().catch((e) => console.log(e));
        init3D();

        const statusDiv = document.getElementById("status");

        function toggleState() {
          if (state === "TREE") {
            state = "EXPLODE";
            statusDiv.innerText = "ðŸŽ„ GiÃ¡ng Sinh An LÃ nh ðŸŽ„";
            statusDiv.style.color = "#FFA500";
          } else if (state === "EXPLODE") {
            state = "PHOTO";
            statusDiv.innerText = "ðŸŽ„ GiÃ¡ng Sinh An LÃ nh ðŸŽ„";
            statusDiv.style.color = "#00FFFF";
          } else {
            state = "TREE";
            statusDiv.innerText = "ðŸŽ„ GiÃ¡ng Sinh An LÃ nh ðŸŽ„";
            statusDiv.style.color = "#FFD700";
          }
        }

        // Chá»‰ khi click/tap má»›i Ä‘á»•i tráº¡ng thÃ¡i
        document.body.addEventListener("click", toggleState);
        let touchStartX = 0;
let touchMoved = false;

document.body.addEventListener("touchstart", (e) => {
  touchStartX = e.touches[0].clientX;
  touchMoved = false;
});

document.body.addEventListener("touchmove", (e) => {
  touchMoved = true;
  handX = e.touches[0].clientX / window.innerWidth;
});

document.body.addEventListener("touchend", () => {
  if (!touchMoved) {
    // Náº¿u khÃ´ng vuá»‘t â†’ coi lÃ  tap â†’ Ä‘á»•i tráº¡ng thÃ¡i
    toggleState();
  }
});

        // Äiá»u khiá»ƒn xoay báº±ng chuá»™t
        document.addEventListener("mousemove", (e) => {
          handX = e.clientX / window.innerWidth;
        });

        // Äiá»u khiá»ƒn xoay báº±ng cáº£m á»©ng (mobile)
        document.addEventListener("touchmove", (e) => {
          if (e.touches.length > 0) {
            handX = e.touches[0].clientX / window.innerWidth;
          }
        });
      }

      // Resize
      window.addEventListener("resize", () => {
        if (camera) {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
        }
      });

      function logError(e) {
        const el = document.getElementById("error-log");
        el.style.display = "block";
        el.innerText += e + "\n";
      }
      window.onload = startSystem;
    </script>
    <audio
      id="bgMusic"
      src="./audio.mp3"
      autoplay
      loop
      muted
      preload="auto"
    ></audio>
    <script>
      // Bá» muted sau thao tÃ¡c Ä‘áº§u tiÃªn
      document.body.addEventListener(
        "click",
        () => {
          document.getElementById("bgMusic").muted = false;
        },
        { once: true }
      );
    </script>
  </body>
</html>






